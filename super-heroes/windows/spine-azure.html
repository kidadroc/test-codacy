<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<meta name="author" content="Antonio Goncalves">
<title>Deploy to Azure Container Apps Workshop</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<head>

    <meta name="keywords" content="Quarkus, Workshop, Microservice, Kafka">
    <meta name="description" content="A hands on lab about Quarkus">

    <link href="assets/css/bootstrap.css" media="screen" rel="stylesheet">
    <link href="assets/css/font-awesome.min.css" media="screen" rel="stylesheet">
    <link href="assets/css/hol.css" media="screen" rel="stylesheet">
    <link href="assets/css/github.css" media="screen" rel="stylesheet">
    <script src="assets/js/jquery-3.1.1.js"></script>
    <script src="assets/js/bootstrap.js"></script>
    <!-- be aware that only a few languages have been included-->
    <script src="assets/js/highlight.pack.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>


    <script>
        $(document).ready(function () {
            hljs.initHighlightingOnLoad();
            $('pre.highlight code').each(function (i, block) {
                hljs.highlightBlock(block);
            });

            var pre = document.getElementsByTagName('pre');
            for (var i = 0; i < pre.length; i++) {
                var b = document.createElement('button');
                b.className = 'clipboard';
                b.textContent = 'Copy';
                if (pre[i].childNodes.length === 1 && pre[i].childNodes[0].nodeType === 3) {
                    var div = document.createElement('div');
                    div.textContent = pre[i].textContent;
                    pre[i].textContent = '';
                    pre[i].appendChild(div);
                }
                pre[i].appendChild(b);
            }
            var clipboard = new ClipboardJS('.clipboard', {
                target: function (b) {
                    var p = b.parentNode;
                    return p.getElementsByClassName("code")[0]
                        ? p.getElementsByClassName("code")[0]
                        : p.childNodes[0];
                }
            });
            clipboard.on('success', function (e) {
                e.clearSelection();
                e.trigger.textContent = 'Copied';
                setTimeout(function () {
                    e.trigger.textContent = 'Copy';
                }, 2000);
            });
        });
    </script>
</head>
<header>
    <img src="images/quarkus-logo.png" alt="Quarkus Logo"/>
</header>

</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Deploy to Azure Container Apps Workshop</h1>
<div class="details">
<span id="author" class="author">Antonio Goncalves</span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2023-10-03</span>
<br><span id="revremark">Quarkus 3.4.1</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#azure">Welcome</a>
<ul class="sectlevel2">
<li><a href="#azure-intro-presenting">Presenting the Workshop</a>
<ul class="sectlevel3">
<li><a href="#_what_will_you_be_deploying">What Will You Be Deploying?</a></li>
<li><a href="#_how_does_this_workshop_work">How Does This Workshop Work?</a></li>
<li><a href="#_what_do_you_have_to_do">What Do You Have to Do?</a></li>
<li><a href="#_software_requirements">Software Requirements</a></li>
</ul>
</li>
<li><a href="#azure-intro-installing">Installing Software</a>
<ul class="sectlevel3">
<li><a href="#azure-intro-installing-wsl">WSL</a></li>
<li><a href="#azure-intro-installing-azure-cli">Azure CLI</a></li>
<li><a href="#introduction-installing-docker">Docker or Podman</a></li>
<li><a href="#introduction-installing-git">Git</a></li>
<li><a href="#_recap">Recap</a></li>
</ul>
</li>
<li><a href="#azure-intro-preparing">Preparing for the Workshop</a>
<ul class="sectlevel3">
<li><a href="#_clone_the_github_repository_of_the_application">Clone the GitHub repository of the application</a></li>
<li><a href="#introduction-preparing-checking-ports">Checking Ports</a></li>
<li><a href="#appendix-preparing-warming-caches">Warming the caches</a></li>
<li><a href="#_setting_up_azure">Setting Up Azure</a></li>
<li><a href="#_creating_azure_resources">Creating Azure Resources</a></li>
<li><a href="#_setting_up_the_environment_variables">Setting Up the Environment Variables</a></li>
<li><a href="#_ready">Ready?</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#azure-aca">Azure Container Apps and Quarkus</a>
<ul class="sectlevel2">
<li><a href="#_whats_azure_container_apps">What&#8217;s Azure Container Apps?</a></li>
<li><a href="#quarkus-definition">What&#8217;s Quarkus?</a></li>
</ul>
</li>
<li><a href="#azure-local-running-app">Running the Application Locally</a>
<ul class="sectlevel2">
<li><a href="#_building_containers">Building containers</a></li>
<li><a href="#_running_local_containers">Running local containers</a></li>
<li><a href="#_pushing_containers_to_azure_container_registry">Pushing containers to Azure Container Registry</a></li>
<li><a href="#_running_remote_containers">Running remote containers</a></li>
</ul>
</li>
<li><a href="#azure-aca-running-app">Running the Application on Azure Container Apps</a>
<ul class="sectlevel2">
<li><a href="#_deploying_the_infrastructure">Deploying the Infrastructure</a>
<ul class="sectlevel3">
<li><a href="#_create_a_container_apps_environment">Create a Container Apps environment</a></li>
<li><a href="#_create_the_managed_postgres_databases">Create the managed Postgres Databases</a></li>
<li><a href="#_create_the_managed_kafka">Create the Managed Kafka</a></li>
</ul>
</li>
<li><a href="#_deploying_the_applications">Deploying the Applications</a>
<ul class="sectlevel3">
<li><a href="#_heroes_microservice">Heroes Microservice</a></li>
<li><a href="#_villains_microservice">Villains Microservice</a></li>
<li><a href="#_statistics_microservice">Statistics Microservice</a></li>
<li><a href="#_fights_microservice">Fights Microservice</a></li>
<li><a href="#_super_hero_ui">Super Hero UI</a></li>
</ul>
</li>
<li><a href="#_running_the_application">Running the Application</a></li>
</ul>
</li>
<li><a href="#azure-conclusion">Clean Up Azure Resources</a></li>
<li><a href="#_conclusion">Conclusion</a></li>
<li><a href="#azure-conclusion-references">References</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="azure">Welcome</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s say you are not a (Java) developer, and you are interested in deploying your applications to the cloud.
You know some Docker, you don&#8217;t know anything about Kubernetes (and don&#8217;t want to learn), but you have heard of <a href="https://azure.microsoft.com">Microsoft Azure</a>.
This workshop is for you.</p>
</div>
<div class="paragraph">
<p>This workshop offers attendees an intro-level, hands-on session with <a href="https://azure.microsoft.com/services/container-apps">Azure Container Apps</a>, from pushing containerized microservices, to deploying an entire infrastructure, to execute microservices and consuming them.
But, what are we going to deploy to Azure Container Apps?
Well, it&#8217;s going to be a set of microservices:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Developed with <a href="https://quarkus.io">Quarkus</a> (the microservices are already developed, and you don&#8217;t need to know Quarkus)</p>
</li>
<li>
<p>Exposing HTTP APIs</p>
</li>
<li>
<p>Exchanging events with Apache Kafka</p>
</li>
<li>
<p>Storing data in databases</p>
</li>
<li>
<p>With some parts of the dark side of microservices (resilience, health, monitoring)</p>
</li>
<li>
<p>Answer the ultimate question: are super-heroes stronger than super-villains?</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This workshop is a BYOL (<em>Bring Your Own Laptop</em>) session, so bring your Windows, OSX, or Linux laptop, and be ready to install a few set of tools.
What you are going to learn:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What is Azure Container Apps and what is Quarkus</p>
</li>
<li>
<p>How to build Docker images out of an existing Java application</p>
</li>
<li>
<p>How to execute the Docker images locally with Docker Compose</p>
</li>
<li>
<p>How to push the Docker images to Azure Registry</p>
</li>
<li>
<p>How to create managed services in Azure (Postgres database, Kafka)</p>
</li>
<li>
<p>How to deploy microservices to Azure Container Apps</p>
</li>
<li>
<p>How to configure Docker images in Azure Container Apps</p>
</li>
<li>
<p>How you improve the resilience of our microservices</p>
</li>
<li>
<p>And much more!</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ready? Here we go!
Check the workshop at <a href="https://quarkus.io/quarkus-workshops/super-heroes/index-azure.html" class="bare">https://quarkus.io/quarkus-workshops/super-heroes/index-azure.html</a> of flash the QR Code if you don’t want to type.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/azure-aca-qrcode.png" alt="azure aca qrcode">
</div>
</div>
<div class="sect2">
<h3 id="azure-intro-presenting">Presenting the Workshop</h3>
<div class="paragraph">
<p>This workshop should give you a practical introduction to Azure Container Apps.
You will practice all the needed tools to deploy an entire microservice architecture, mixing classical HTTP, reactive and event-based microservices.
You will finish by monitoring and scaling the microservices so they can handle the load.</p>
</div>
<div class="paragraph">
<p>The idea is that you leave this workshop with a good understanding of what Azure Container Apps is, what it is not, and how it can help you in your projects.
Then, you&#8217;ll be prepared to investigate a bit more on your own.</p>
</div>
<div class="sect3">
<h4 id="_what_will_you_be_deploying">What Will You Be Deploying?</h4>
<div class="paragraph">
<p>In this workshop, you will deploy an existing application that allows superheroes to fight against supervillains.
You will be containerizing and deploying several microservices communicating either synchronously via REST or asynchronously using Kafka:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Super Hero UI</em>: an Angular application to pick up a random superhero, a random supervillain, and makes them fight.
The Super Hero UI is exposed via Quarkus and invokes the Fight REST API.</p>
</li>
<li>
<p><em>Villain REST API</em>: A classical HTTP microservice exposing CRUD operations on Villains, stored in a PostgreSQL database.</p>
</li>
<li>
<p><em>Hero REST API</em>: A reactive HTTP microservice exposing CRUD operations on Heroes, stored in a Postgres database.</p>
</li>
<li>
<p><em>Fight REST API</em>: This REST API invokes the Hero and Villain APIs to get a random superhero and supervillain.
Each fight is, then, stored in a PostgreSQL database.
This microservice can be developed using both the classical (<em>imperative</em>) or reactive approach.
Invocations to the hero and villain services are protected using resilience patterns (retry, timeout, circuit-breakers).</p>
</li>
<li>
<p><em>Statistics</em>: Each fight is asynchronously sent (via Kafka) to the Statistics microservice.
It has an HTML + JQuery UI displaying all the statistics.</p>
</li>
</ul>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="images/diag-plantuml-md5-e02bbaf637a94b52982898cd47c02fa9.png" alt="Diagram" width="2865" height="2865">
</div>
</div>
<div class="paragraph">
<p>The main UI allows you to pick up one random Hero and Villain by clicking on "New Fighters."
Then it&#8217;s just a matter of clicking on "Fight!" to get them to fight.
The table at the bottom shows the list of the previous fights.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/angular-ui-ai.png" alt="angular ui ai">
</div>
</div>
<div class="paragraph">
<p>The Statistics UI shows the number of fights per hero and villain.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="images/angular-ui-stats.png" alt="angular ui stats">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_how_does_this_workshop_work">How Does This Workshop Work?</h4>
<div class="paragraph">
<p>You have this material in your hands (either electronically or printed), and you can now follow it step by step.
The structure of this workshop is as follow :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Installing all the needed tools</em>:
in this section, you will install all the tools and code to be able to bundle, package and deploy our application</p>
</li>
<li>
<p><em>Azure Container Apps and Quarkus</em>:
this section introduces Quarkus and Azure Container Apps to make sure you have all the needed vocabulary to follow along</p>
</li>
<li>
<p><em>Running the Application Locally</em>:
in this section, you will build Docker images out of Quarkus microservices, execute them locally with Docker compose, push them to Azure Registry, all that using Docker and Azure CLI</p>
</li>
<li>
<p><em>Running the Application on Azure Container Apps</em>:
in this section, you will create an entire infrastructure on Azure (Postgres databases, Kafka, etc.) and deploy the microservices to Azure Container Apps</p>
</li>
<li>
<p><em>Administrating</em>:
in this section, you will add some load to your microservices, monitor them, scale them, check the logs, etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you already have the tools installed, skip the <em>Installing all the needed tools</em> section and jump to the sections <em>Azure Container Apps and Quarkus</em> or straight to <em>Running the Application Locally</em> (if you already know Quarkus and Azure Container Apps), and start hacking on the command lines.
This "à la carte" mode lets you make the most of this 2 to 4-hour long hands-on lab.</p>
</div>
</div>
<div class="sect3">
<h4 id="_what_do_you_have_to_do">What Do You Have to Do?</h4>
<div class="paragraph">
<p>This workshop should be as self-explanatory as possible.
So your job is to follow the instructions by yourself, do what you are supposed to do, and do not hesitate to ask for any clarification or assistance;
that&#8217;s why the team is here.</p>
</div>
<div class="paragraph">
<p>Oh, and be ready to have some fun!</p>
</div>
</div>
<div class="sect3">
<h4 id="_software_requirements">Software Requirements</h4>
<div class="paragraph">
<p>First of all, make sure you have a 64bits computer with admin rights (so you can install all the needed tools) and at least 16Gb of RAM (as some tools need a few resources).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using Mac OS X, make sure the version is greater than 10.11.x (Captain).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This workshop will make use of the following software, tools, frameworks that you will need to install and now (more or less) how it works:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure CLI</p>
</li>
<li>
<p>Docker</p>
</li>
<li>
<p>cURL (or any other command line HTTP client)</p>
</li>
<li>
<p>(optionally) Any IDE you feel comfortable with (eg. Intellij IDEA, Eclipse IDE, VS Code..)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following section focuses on how to install and set up the needed software.
You can skip the next section if you have already installed all the prerequisites.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>This workshop assumes a bash shell.
If you run on Windows, in particular, adjust the commands accordingly.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="azure-intro-installing">Installing Software</h3>
<div class="paragraph">
<p>For this workshop you don&#8217;t need to have a Java environment setup on your machine.
All the Java code will be build with multistage Dockerfile builds.
So only Docker is needed to build, deploy and execute the application.
As for deploying the infrastructure and the application to Azure, we will use Azure CLI.</p>
</div>
<div class="sect3">
<h4 id="azure-intro-installing-wsl">WSL</h4>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/windows/wsl">Windows Subsystem for Linux</a> (WSL) lets developers run a GNU/Linux environment&#8201;&#8212;&#8201;including most command-line tools, utilities, and applications&#8201;&#8212;&#8201;directly on Windows, unmodified, without the overhead of a traditional virtual machine or dual-boot setup.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are using Windows, it is recommended to install WSL.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_installing_wsl">Installing WSL</h5>
<div class="paragraph">
<p>You can install everything you need to run Windows Subsystem for Linux (WSL) by entering this command in an administrator PowerShell or Windows Command Prompt and then restarting your machine:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">wsl --install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command will enable the required optional components, download the latest Linux kernel, set WSL 2 as your default, and install a Linux distribution for you (Ubuntu by default).</p>
</div>
<div class="paragraph">
<p>The first time you launch a newly installed Linux distribution, a console window will open and you&#8217;ll be asked to wait for files to de-compress and be stored on your machine.
All future launches should take less than a second.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="azure-intro-installing-azure-cli">Azure CLI</h4>
<div class="paragraph">
<p>The Azure command-line interface (<a href="https://docs.microsoft.com/cli/azure">Azure CLI)</a> is a set of commands used to create and manage Azure resources.
The Azure CLI is available across Azure services and is designed to get you working quickly with Azure, with an emphasis on automation.
For this workshop you need to have Azure CLI installed locally on your machine.</p>
</div>
<div class="sect4">
<h5 id="_installing_azure_cli">Installing Azure CLI</h5>
<div class="paragraph">
<p>The <a href="https://docs.microsoft.com/cli/azure/install-azure-cli">Azure CLI is available to install</a> in Windows, macOS and Linux environments.
It can also be run in a Docker container and Azure Cloud Shell.
On Mac OS X, the easiest way to install Azure CLI is by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">brew install azure-cli</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_checking_for_azure_cli_installation">Checking for Azure CLI Installation</h5>
<div class="paragraph">
<p>Once the installation is complete, you can execute a few commands to be sure the Azure CLI is correctly installed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az version
az --version</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_some_azure_cli_commands">Some Azure CLI Commands</h5>
<div class="paragraph">
<p>Azure CLI is a command-line utility where you can use several parameters and options to create, query, or delete Azure resources.
To get some help on the commands, you can type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az help
az --help
az vm --help
az vm disk --help
az vm disk attach --help</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="introduction-installing-docker">Docker or Podman</h4>
<div class="paragraph">
<p>Docker is a set of utilities that use OS-level virtualization to deliver software in packages called containers.
Containers are isolated from one another and bundle their software, libraries, and configuration files;
they can communicate with each other through well-defined channels.</p>
</div>
<div class="sect4">
<h5 id="_installing_docker">Installing Docker</h5>
<div class="paragraph">
<p>Quarkus use Testcontainers, and therefore also Docker, to ease the management of different technical services (database, monitoring&#8230;&#8203;) during development.
Our workshop also uses Docker to manage these services in a production-style deployment.
So for this, we need to install <code>docker</code> and <code>docker compose</code>
Installation instructions are available on the following page:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mac OS X - <a href="https://docs.docker.com/docker-for-mac/install/" class="bare">https://docs.docker.com/docker-for-mac/install/</a> (version 20+)</p>
</li>
<li>
<p>Windows - <a href="https://docs.docker.com/docker-for-windows/install/" class="bare">https://docs.docker.com/docker-for-windows/install/</a> (version 20+)</p>
</li>
<li>
<p>CentOS - <a href="https://docs.docker.com/install/linux/docker-ce/centos/" class="bare">https://docs.docker.com/install/linux/docker-ce/centos/</a></p>
</li>
<li>
<p>Debian - <a href="https://docs.docker.com/install/linux/docker-ce/debian/" class="bare">https://docs.docker.com/install/linux/docker-ce/debian/</a></p>
</li>
<li>
<p>Fedora - <a href="https://docs.docker.com/install/linux/docker-ce/fedora/" class="bare">https://docs.docker.com/install/linux/docker-ce/fedora/</a></p>
</li>
<li>
<p>Ubuntu - <a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" class="bare">https://docs.docker.com/install/linux/docker-ce/ubuntu/</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On Linux, don&#8217;t forget the post-execution steps described on <a href="https://docs.docker.com/install/linux/linux-postinstall/" class="bare">https://docs.docker.com/install/linux/linux-postinstall/</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you do not have a Docker licence, you might prefer <code>podman</code> (<a href="https://podman.io/" class="bare">https://podman.io/</a>) instead of <code>docker</code>. To install <code>podman</code> and <code>podman-compose</code> please follow the instructions at <a href="https://quarkus.io/guides/podman" class="bare">https://quarkus.io/guides/podman</a>. Do not forget the extra steps to configure the testcontainers library. As a convenience you can even alias <code>docker</code> to <code>podman</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_checking_for_docker_installation">Checking for Docker Installation</h5>
<div class="paragraph">
<p>Once installed, check that both <code>docker</code> and <code>docker compose</code> are available in your <code>PATH</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ docker version
Docker version 20.10.8, build 3967b7d
Cloud integration: v1.0.24
Version:           20.10.14
API version:       1.41

$ docker compose version
Docker Compose version v2.5.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, run your first container as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ docker run hello-world

Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
1. The Docker client contacted the Docker daemon.
2. The Docker daemon pulled the "hello-world" image from the Docker Hub.
(amd64)
3. The Docker daemon created a new container from that image which runs the
executable that produces the output you are currently reading.
4. The Docker daemon streamed that output to the Docker client, which sent it
to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
$ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker ID:
 https://hub.docker.com/

For more examples and ideas, visit:
 https://docs.docker.com/get-started/</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_some_docker_commands">Some Docker Commands</h5>
<div class="paragraph">
<p>Docker is a command-line utility where you can use several parameters and options to start/stop a container.
You invoke <code>docker</code> with zero, one, or several command-line options with the container or image ID you want to work with.
Docker comes with several options that are described in the documentation if you need more help.<sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>
To get some help on the commands and options, you can type, use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ docker help

Usage:  docker [OPTIONS] COMMAND

$ docker help attach

Usage:  docker attach [OPTIONS] CONTAINER

Attach local standard input, output, and error streams to a running container</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here are some commands that you will be using to start/stop containers in this workshop.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>docker container ls</code>: Lists containers.</p>
</li>
<li>
<p><code>docker container start CONTAINER</code>: Starts one or more stopped containers.</p>
</li>
<li>
<p><code>docker compose -f docker-compose.yaml up -d</code>: Starts all containers defined in a Docker Compose file.</p>
</li>
<li>
<p><code>docker compose -f docker-compose.yaml down</code>: Stops all containers defined in a Docker Compose file.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="introduction-installing-git">Git</h4>
<div class="paragraph">
<p>Git&#8288;<sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup> is a free and open source distributed version control system designed for tracking changes in computer files and coordinating work on those files among multiple people.
It is primarily used for source code management in software development, but it can be used to keep track of changes in any set of files.
Git was created by Linus Torvalds in 2005 for the development of the Linux kernel, with other kernel developers contributing to its initial development.</p>
</div>
<div class="sect4">
<h5 id="_installing_git">Installing Git</h5>
<div class="paragraph">
<p>On Mac, if you have installed Homebrew, then installing Git is just a matter of a single command.
Open your terminal and install Git with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ brew install git</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_checking_for_git_installation">Checking for Git Installation</h5>
<div class="paragraph">
<p>Once installed, check for Git by running <code>git --version</code> in the terminal.
It should display the git version:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-term" data-lang="term">$ git --version</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_recap">Recap</h4>
<div class="paragraph">
<p>Just make sure the following commands work on your machine.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">$ az --version
$ docker version
$ docker compose version
$ curl --version
$ git --version</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="azure-intro-preparing">Preparing for the Workshop</h3>
<div class="paragraph">
<p>This workshop needs internet to access Azure of course, but also to download all sorts of Maven artifacts, Docker images, and even pictures.
Some of these artifacts are large, and because we have to share internet connexions at the workshop, it is better to download them before the workshop.
Here are a few commands that you can execute before the workshop.</p>
</div>
<div class="sect3">
<h4 id="_clone_the_github_repository_of_the_application">Clone the GitHub repository of the application</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>First, clone the GitHub repository of the Super Heroes application located at <a href="https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes" class="bare">https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes</a> by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">git clone https://github.com/quarkusio/quarkus-workshops.git --depth 1</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>The code of this Super Heroes application is separated into two different directories:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-plantuml-md5-212f96fa2bf7640c4a678243922e2fe6.png" alt="Diagram" width="437" height="38">
</div>
</div>
<div class="paragraph">
<p>Under the <code>super-heroes</code> directory you will find the entire Super Hero application spread throughout a set of subdirectories, each one containing a microservice or some tooling.
The final structure will be the following:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/diag-plantuml-md5-c9d2d0d47fd69b88ad68423497c6857e.png" alt="Diagram" width="651" height="150">
</div>
</div>
</div>
<div class="sect3">
<h4 id="introduction-preparing-checking-ports">Checking Ports</h4>
<div class="paragraph">
<p>During this workshop, we will use several ports.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Use <code>lsof</code> to make sure the following ports are free, so you don&#8217;t run into any conflicts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">lsof -i tcp:8080    # UI
lsof -i tcp:8082    # Fight REST API
lsof -i tcp:8083    # Hero REST API
lsof -i tcp:8084    # Villain REST API
lsof -i tcp:8085    # Statistics REST API
lsof -i tcp:8086    # Narration REST API
lsof -i tcp:5432    # Postgres
lsof -i tcp:9090    # Prometheus
lsof -i tcp:2181    # Zookeeper
lsof -i tcp:9092    # Kafka</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="appendix-preparing-warming-caches">Warming the caches</h4>
<div class="paragraph">
<p>This workshop needs internet access to download all sorts of Maven artifacts, Docker images, and even pictures.
Some of these artifacts are large, and because we have to share internet connexions at the workshop, it is better to download them before the workshop.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re getting ready for a workshop, you might find it helpful to pre-download some Docker images.
This can save strain on shared bandwidth. If, however, you&#8217;re already attending a workshop, don&#8217;t
worry about warming anything up.</p>
</div>
<div class="sect4">
<h5 id="_warming_up_maven">Warming up Maven</h5>
<div class="sect5">
<h6 id="_download_the_workshop_scaffolding">Download the workshop scaffolding</h6>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>First, download the zip file  <a href="https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/dist/quarkus-super-heroes-workshop.zip" class="bare">https://raw.githubusercontent.com/quarkusio/quarkus-workshops/refs/heads/main/quarkus-workshop-super-heroes/dist/quarkus-super-heroes-workshop.zip</a>, and unzip it wherever you want.
This zip file contains <em>some</em> of the code of the workshop, and you will need to complete it.</p>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_download_the_maven_dependencies">Download the Maven dependencies</h6>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Now that you have the initial structure in place, navigate to the root directory and run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">./mvnw clean install</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>By running this command, it downloads all the required dependencies.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="appendix-preparing-warming-docker">Warming up Docker images</h5>
<div class="paragraph">
<p>To warm up your Docker image repository, navigate to the <code>quarkus-workshop-super-heroes/super-heroes/infrastructure</code> directory.
Here, you will find a
<code>docker-compose.yaml</code>
 or
<code>docker-compose-linux.yaml</code>
file which defines all the needed Docker images.
Notice that there is a <code>db-init</code> directory with an <code>initialize-databases.sql</code> script which sets up our databases, and a <code>monitoring</code> directory (all that will be explained later).</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Then execute the following command which will download all the Docker images and start the containers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker compose -f docker-compose.yaml up -d</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Linux Users beware</div>
<div class="paragraph">
<p>If you are on Linux, use <code>docker-compose-linux.yaml</code> instead of <code>docker-compose.yaml</code>. This Linux specific file will allow Prometheus to fetch metrics from the services running on the host machine.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you have an issue creating the roles for the database with the <code>initialize-databases.sql</code> file, you have to execute the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker exec -it --user postgres super-database psql -c "CREATE ROLE superman LOGIN PASSWORD 'superman' NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION"
docker exec -it --user postgres super-database psql -c "CREATE ROLE superbad LOGIN PASSWORD 'superbad' NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION"
docker exec -it --user postgres super-database psql -c "CREATE ROLE superfight LOGIN PASSWORD 'superfight' NOSUPERUSER INHERIT NOCREATEDB NOCREATEROLE NOREPLICATION"</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>After this, verify the containers are running using the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker compose -f docker-compose.yaml ps</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should resemble something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">     Name                   Command               State           Ports
--------------------------------------------------------------------------------
kafka            sh -c bin/kafka-server-sta ...   Up      0.0.0.0:9092-&gt;9092/tcp
super-database   docker-entrypoint.sh postgres    Up      0.0.0.0:5432-&gt;5432/tcp
super-visor      /bin/prometheus --config.f ...   Up      0.0.0.0:9090-&gt;9090/tcp
zookeeper        sh -c bin/zookeeper-server ...   Up      0.0.0.0:2181-&gt;2181/tcp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all the containers are up and running, you can shut them down and remove their volumes with the commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker compose -f docker-compose.yaml down
docker compose -f docker-compose.yaml rm</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<div class="title">What&#8217;s this infra?</div>
<p>Any microservice system is going to rely on a set of technical services.
In our context, we are going to use PostgreSQL as the database, Prometheus as the monitoring tool, and Kafka as the event/message bus.
This infrastructure starts all these services, so you don&#8217;t have to worry about them.</p>
</div>
<div class="paragraph">
<p>This infra will only be used when we run our services in <em>prod</em> mode. In <em>dev</em> mode, Quarkus will start everything for us.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_azure">Setting Up Azure</h4>
<div class="paragraph">
<p>To be able to deploy the application to Azure, you first need an Azure subscription.
If you don&#8217;t have one, go to <a href="https://signup.azure.com" class="bare">https://signup.azure.com</a> and register.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Then, sign in to Azure from the CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az login</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure you are using the right subscription with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az account show</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_setting_up_the_azure_environment">Setting Up the Azure Environment</h5>
<div class="paragraph">
<p>Azure CLI is extensible and you can install as many extensions as you need.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>For this workshop, install the Azure Container Apps and Database extensions for the Azure CLI:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az extension add --name containerapp  --upgrade
az extension add --name rdbms-connect --upgrade
az extension add --name log-analytics --upgrade</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then check the extensions that are installed in your system with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az extension list</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the extensions that have been installed:</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you are on Windows and using WSL, the extensions should be installed under <code>/home/&lt;user&gt;/.azure/cliextensions/</code>.
If it&#8217;s not the case, and instead extensions are installed under <code>C:\\Users\\&lt;user&gt;\\.azure\\cliextensions</code>, you should reboot your computer.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-json" data-lang="json">[
  ...
  {
    "experimental": false,
    "extensionType": "whl",
    "name": "containerapp",
    "path": "/Users/agoncal/.azure/cliextensions/containerapp",
    "preview": true,
    "version": "0.3.4"
  },
  ...
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, register the needed Azure namespaces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az provider register --namespace Microsoft.App
az provider register --namespace Microsoft.OperationalInsights
az provider register --namespace Microsoft.Insights</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_azure_resources">Creating Azure Resources</h4>
<div class="paragraph">
<p>Before creating the infrastructure for the Super Heroes application and deploying the microservices to Azure Container Apps, we need to create some Azure resources.</p>
</div>
<div class="sect4">
<h5 id="_setting_up_the_azure_environment_variables">Setting Up the Azure environment variables</h5>
<div class="paragraph">
<p>Let&#8217;s first set a few environment variables that will help us in creating the Azure infrastructure.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Set the following variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">PROJECT="super-heroes"
RESOURCE_GROUP="rg-${PROJECT}"
LOCATION="eastus"
TAG=$PROJECT

LOG_ANALYTICS_WORKSPACE="log-${PROJECT}"

UNIQUE_IDENTIFIER=$(whoami)
REGISTRY="registrysuperheroes"$UNIQUE_IDENTIFIER
IMAGES_TAG="1.0"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now let&#8217;s create the Azure resources.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_resource_group">Resource Group</h5>
<div class="paragraph">
<p>A <a href="https://docs.microsoft.com/azure/azure-resource-manager/management/manage-resource-groups-portal">resource group</a> is a container that holds related resources for an Azure solution.
The resource group can include all the resources for the solution, or only those resources that you want to manage as a group.
In our workshop, all the databases, all the microservices, etc. will be grouped into a single resource group.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Execute the following command to create the Super Hero resource group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az group create \
  --name "$RESOURCE_GROUP" \
  --location "$LOCATION" \
  --tags system="$TAG"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_log_analytics_workspace">Log Analytics Workspace</h5>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/azure/azure-monitor/logs/quick-create-workspace">Log Analytics workspace</a> is the environment for Azure Monitor log data.
Each workspace has its own data repository and configuration, and data sources and solutions are configured to store their data in a particular workspace.
We will use the same workspace for most of the Azure resources we will be creating.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create a Log Analytics workspace with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az monitor log-analytics workspace create \
  --resource-group "$RESOURCE_GROUP" \
  --location "$LOCATION" \
  --tags system="$TAG" \
  --workspace-name "$LOG_ANALYTICS_WORKSPACE"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s also retrieve the Log Analytics Client ID and client secret and store them in environment variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">LOG_ANALYTICS_WORKSPACE_CLIENT_ID=`az monitor log-analytics workspace show  \
  --resource-group "$RESOURCE_GROUP" \
  --workspace-name "$LOG_ANALYTICS_WORKSPACE" \
  --query customerId  \
  --output tsv | tr -d '[:space:]'`

echo $LOG_ANALYTICS_WORKSPACE_CLIENT_ID

LOG_ANALYTICS_WORKSPACE_CLIENT_SECRET=`az monitor log-analytics workspace get-shared-keys \
  --resource-group "$RESOURCE_GROUP" \
  --workspace-name "$LOG_ANALYTICS_WORKSPACE" \
  --query primarySharedKey \
  --output tsv | tr -d '[:space:]'`

echo $LOG_ANALYTICS_WORKSPACE_CLIENT_SECRET</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_azure_container_registry">Azure Container Registry</h5>
<div class="paragraph">
<p>In the next chapters we will be creating Docker containers and pushing them to the Azure Container Registry.
<a href="https://azure.microsoft.com/services/container-registry">Azure Container Registry</a> is a private registry for hosting container images.
Using the Azure Container Registry, you can store Docker-formatted images for all types of container deployments.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>First, let&#8217;s created an Azure Container Registry with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az acr create \
  --resource-group "$RESOURCE_GROUP" \
  --location "$LOCATION" \
  --tags system="$TAG" \
  --name "$REGISTRY" \
  --workspace "$LOG_ANALYTICS_WORKSPACE" \
  --sku Premium \
  --admin-enabled true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Update the repository to allow anonymous users to pull the images:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az acr update \
  --resource-group "$RESOURCE_GROUP" \
  --name "$REGISTRY" \
  --anonymous-pull-enabled true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Get the URL of the Azure Container Registry and set it to the <code>REGISTRY_URL</code> variable with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">REGISTRY_URL=$(az acr show \
  --resource-group "$RESOURCE_GROUP" \
  --name "$REGISTRY" \
  --query "loginServer" \
  --output tsv)

echo $REGISTRY_URL</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you log into the <a href="https://portal.azure.com">Azure Portal</a> you should see the following created resources.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/azure-portal-2.png" alt="azure portal 2">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_setting_up_the_environment_variables">Setting Up the Environment Variables</h4>
<div class="paragraph">
<p>The Super Heroes environment and application will be created and deployed using a set of Azure CLI commands.
Each of these commands need a set of parameters, and some of these parameters can be set of environment variables.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Set the following environment variables, there will be needed in the Azure CLI commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell"># Container Apps
CONTAINERAPPS_ENVIRONMENT="env-${PROJECT}"

# Postgres
POSTGRES_DB_ADMIN="superheroesadmin"
POSTGRES_DB_PWD="super-heroes-p#ssw0rd-12046"
POSTGRES_DB_VERSION="14"
POSTGRES_SKU="Standard_B1ms"
POSTGRES_TIER="Burstable"

# Kafka
KAFKA_NAMESPACE="fights-kafka-$UNIQUE_IDENTIFIER"
KAFKA_TOPIC="fights"
KAFKA_BOOTSTRAP_SERVERS="$KAFKA_NAMESPACE.servicebus.windows.net:9093"

# Heroes
HEROES_APP="heroes-app"
HEROES_DB="heroes-db-$UNIQUE_IDENTIFIER"
HEROES_IMAGE="${REGISTRY_URL}/${HEROES_APP}:${IMAGES_TAG}"
HEROES_DB_SCHEMA="heroes"
HEROES_DB_CONNECT_STRING="postgresql://${HEROES_DB}.postgres.database.azure.com:5432/${HEROES_DB_SCHEMA}?ssl=true&amp;sslmode=require"

# Villains
VILLAINS_APP="villains-app"
VILLAINS_DB="villains-db-$UNIQUE_IDENTIFIER"
VILLAINS_IMAGE="${REGISTRY_URL}/${VILLAINS_APP}:${IMAGES_TAG}"
VILLAINS_DB_SCHEMA="villains"
VILLAINS_DB_CONNECT_STRING="jdbc:postgresql://${VILLAINS_DB}.postgres.database.azure.com:5432/${VILLAINS_DB_SCHEMA}?ssl=true&amp;sslmode=require"

# Fights
FIGHTS_APP="fights-app"
FIGHTS_DB="fights-db-$UNIQUE_IDENTIFIER"
FIGHTS_IMAGE="${REGISTRY_URL}/${FIGHTS_APP}:${IMAGES_TAG}"
FIGHTS_DB_SCHEMA="fights"
FIGHTS_DB_CONNECT_STRING="jdbc:postgresql://${FIGHTS_DB}.postgres.database.azure.com:5432/${FIGHTS_DB_SCHEMA}?ssl=true&amp;sslmode=require"

# Statistics
STATISTICS_APP="statistics-app"
STATISTICS_IMAGE="${REGISTRY_URL}/${STATISTICS_APP}:${IMAGES_TAG}"

# UI
UI_APP="super-heroes-ui"
UI_IMAGE="${REGISTRY_URL}/${UI_APP}:${IMAGES_TAG}"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_ready">Ready?</h4>
<div class="paragraph">
<p>After the prerequisites have been installed and the different components have been warmed up, and some Azure resource created, it&#8217;s now time to deploy some code!
But before, let us introduce Azure Container Apps and Quarkus.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="azure-aca">Azure Container Apps and Quarkus</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>Even if you won&#8217;t be developing any Quarkus code, you might want to discover why this Java runtime is perfect for developing containerized applications, and why it makes with Azure Container Apps.
And if you don&#8217;t know Azure Container Apps, this chapter is the right time to take a breath and discover this Azure service.
In this chapter, you are going to see:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>What&#8217;s Azure Container Apps?</p>
</li>
<li>
<p>How does Azure Container Apps fit in the long list of Azure services?</p>
</li>
<li>
<p>Pros and cons of using Azure Container Apps</p>
</li>
<li>
<p>What&#8217;s Quarkus? and how does it change the Java landscape</p>
</li>
<li>
<p>What are the main Quarkus idea, and how it helps in the <em>cloud native world</em></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_whats_azure_container_apps">What&#8217;s Azure Container Apps?</h3>
<div class="paragraph">
<p><a href="https://azure.microsoft.com/services/container-apps">Azure Container Apps</a> is a fully managed serverless container service on Azure.
It allows you to run containerized applications without worrying about orchestration or managing complex infrastructure such as Kubernetes.
You write code using your preferred programming language or framework (in this workshop it&#8217;s Java and Quarkus, but it can be anything), and build microservices with full support for Distributed Application Runtime (<a href="https://dapr.io">Dapr</a>).
Then, your containers will scale dynamically based on HTTP traffic or events powered by Kubernetes Event-Driven Autoscaling (<a href="https://keda.sh">KEDA</a>).</p>
</div>
<div class="paragraph">
<p>There are already a few compute resources on Azure: from IAAS to FAAS.
Azure Container Apps sits between PAAS and FAAS.
On one hand, it feels more PaaS, because you are not forced into a specific programming model and you can control the rules on which to scale out / scale in.
On the other hand, it has quite some serverless characteristics like scaling to zero, event-driven scaling, per second pricing and the ability to leverage Dapr&#8217;s event-based bindings.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/azure-aca-compute.png" alt="azure aca compute">
</div>
</div>
<div class="paragraph">
<p>Container Apps is built on top of Azure Kubernetes Service, including a deep integration with KEDA (event-driven auto scaling for Kubernetes), Dapr (distributed application runtime) and Envoy (a service proxy designed for cloud-native applications).
The underlying complexity is completely abstracted for the end-user.
So no need to configure your K8S service, deployment, ingress, volume manifests…
You get a very simple API and user interface to configure the desired configuration for your containerized application.
This simplification means also less control, hence the difference with AKS.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/azure-aca-intro.png" alt="azure aca intro">
</div>
</div>
<div class="paragraph">
<p>Azure Container Apps has the following features:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Revisions</em>: automatic versioning that helps to manage the application lifecycle of your container apps</p>
</li>
<li>
<p><em>Traffic control</em>: split incoming HTTP traffic across multiple revisions for Blue/Green deployments and A/B testing</p>
</li>
<li>
<p><em>Ingress</em>: simple HTTPS ingress configuration, without the need to worry about DNS and certificates</p>
</li>
<li>
<p><em>Autoscaling</em>: leverage all KEDA-supported scale triggers to scale your app based on external metrics</p>
</li>
<li>
<p><em>Secrets</em>: deploy secrets that are securely shared between containers, scale rules and Dapr sidecars</p>
</li>
<li>
<p><em>Monitoring</em>: the standard output and error streams are automatically written to Log Analytics</p>
</li>
<li>
<p><em>Dapr</em>: through a simple flag, you can enable native Dapr integration for your Container Apps</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Azure Container Apps <a href="https://yourazurecoach.com/2021/11/03/container-apps-the-missing-piece-in-the-azure-compute-puzzle">introduce the following concepts</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>Environment</em>: this is a secure boundary around a group of Container Apps.
They are deployed in the same virtual network, these apps can easily intercommunicate easily with each other and they write logs to the same Log Analytics workspace.
An environment can be compared with a Kubernetes namespace.</p>
</li>
<li>
<p><em>Container App</em>: this is a group of containers (pod) that is deployed and scale together.
They share the same disk space and network.</p>
</li>
<li>
<p><em>Revision</em>: this is an immutable snapshot of a Container App.
New revisions are automatically created and are valuable for HTTP traffic redirection strategies, such as A/B testing.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="images/azure-aca-concepts.png" alt="azure aca concepts">
</div>
</div>
</div>
<div class="sect2">
<h3 id="quarkus-definition">What&#8217;s Quarkus?</h3>
<div class="paragraph">
<p>Java was born more than 25 years ago.
The world 25 years ago was quite different.
The software industry has gone through several revolutions over these two decades.
Java has always been able to reinvent itself to stay relevant.</p>
</div>
<div class="paragraph">
<p>But a new revolution is happening.
While for years, most applications were running on huge machines, with lots of CPU and memory, they are now running on the Cloud, in constrained environments, in containers, where the resources are shared.
Density is the new optimization: crank as many mini-apps (or microservices) as possible per node.
And scale by adding more instances of an app instead of a more powerful single instance.</p>
</div>
<div class="paragraph">
<p>The Java ergonomics, designed 20 years ago, do not fit well in this new environment.
Java applications were designed to run 24/7 for months, even years.
The JIT is optimizing the execution over time; the GC manages the memory efficiently&#8230;&#8203;
But all these features have a cost, and the memory required to run Java applications and startup times are showstoppers when you deploy 20 or 50 microservices instead of one application.
The issue is not the JVM itself; it&#8217;s also the Java ecosystem that needs to be reinvented.</p>
</div>
<div class="paragraph">
<p>That&#8217;s where Quarkus, and other projects, enter the game.
Quarkus uses a build time principle.<sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup>
During the build of the application, tasks that usually happen at runtime are executed at build time.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="images/quarkus-build-time-principle.png" alt="quarkus build time principle">
</div>
</div>
<div class="paragraph">
<p>Thus, when the application runs, everything has been pre-computed, and all the annotation scanning, XML parsing, and so on won&#8217;t be executed anymore.
It has two direct benefits: startup time (a lot faster) and memory consumption (a lot lower).</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="images/quarkus-augmentation.png" alt="quarkus augmentation">
</div>
</div>
<div class="paragraph">
<p>So, as depicted in the figure above, Quarkus does bring an infrastructure for frameworks to embrace build time metadata discovery (like annotations), replace proxies with generated classes, pre-configure most frameworks, and handle dependency injection at build time.</p>
</div>
<div class="paragraph">
<p>Also, during the build, Quarkus detects which class needs to be accessed by reflection at runtime, boots framework at build time to record the result, and generally offers a lot of GraalVM optimization for free (or cheap at least).
Indeed, thanks to all this metadata, Quarkus can configure native compilers such as the GraalVM compiler to generate a native executable for your Java application.
Thanks to an aggressive dead-code elimination, the final executable is smaller, faster to start, and uses a ridiculously small amount of memory.</p>
</div>
<div class="imageblock half-size">
<div class="content">
<img src="images/quarkus-native-compilation.png" alt="quarkus native compilation">
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="azure-local-running-app">Running the Application Locally</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>In this chapter we will build containers out of our Quarkus microservices and execute them locally thanks to Docker Compose.
Then, we will push the containers to Azure Container Registry so we can still run them locally, and later on Azure Container Apps.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Building containers locally and pushing them to Azure Container Registry can take from 15 to 30 minutes (depending on your CPU and bandwith).
If you think you will not have enough time to complete the Workshop, you can skip the next optional sections and go straight to <em>Running remote containers</em>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_building_containers">Building containers</h3>
<div class="paragraph">
<p>In this section, we are going to package our microservices into containers.
In particular, we are going to produce Linux 64 bits native executables and runs them in a container.
The native compilation uses the OS and architecture of the host system.</p>
</div>
<div class="paragraph">
<p>And&#8230;&#8203; Linux Containers are &#8230;&#8203; <em>Linux</em>.
So to build a container with a Linux native executable (even if you are on Windows or Mac), Quarkus comes with a trick to produce these executable.
First, Quarkus comes with a set of <code>Dockerfiles</code>.
The <code>Dockerfile.native</code> file is for running the application in native mode.
It looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">FROM registry.access.redhat.com/ubi8/ubi-minimal:8.5
WORKDIR /work/
RUN chown 1001 /work \
    &amp;&amp; chmod "g+rwX" /work \
    &amp;&amp; chown 1001:root /work
COPY --chown=1001:root target/*-runner /work/application

EXPOSE 8080
USER 1001

CMD ["./application", "-Dquarkus.http.host=0.0.0.0"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s a pretty straightforward <code>Dockerfile</code> taking a minimal base image and copying the generated native executable.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Building a native executable takes time, CPU, and memory.
It&#8217;s even more accurate in the container.
So, first, be sure that your container system has enough memory to build the executable.
It requires at least 6Gb of memory, 8Gb is recommended.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Execute the following commands to build all our microservices and the UI.
This will build Docker images out of Linux native executables:
Under the <code>quarkus-workshop-super-heroes/super-heroes</code> directory execute the following Docker commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">cd extension-version
mvn clean install
cd ..

cd rest-heroes
mvn clean package
cd ..

cd rest-villains
mvn clean package
cd ..

cd rest-fights
mvn clean package
cd ..

cd event-statistics
mvn clean package
cd ..</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">cd rest-heroes
docker build -f src/main/docker/Dockerfile.jvm -t quarkus/rest-heroes .
cd ..

cd rest-villains
docker build -f src/main/docker/Dockerfile.jvm -t quarkus/rest-villains ../..
cd ..

cd rest-fights
docker build -f src/main/docker/Dockerfile.jvm -t quarkus/rest-fights .
cd ..

cd event-statistics
docker build -f src/main/docker/Dockerfile.jvm -t quarkus/event-statistics .
cd ..

cd ui-super-heroes
docker build -f src/main/docker/Dockerfile.build-native -t quarkus/ui-super-heroes .
cd ..</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check that you have all the Docker images installed locally:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker image ls | grep quarkus</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output should look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">quarkus/ui-super-heroes         latest      266MB
quarkus/event-statistics        latest      145MB
quarkus/rest-fights             latest      198MB
quarkus/rest-villains           latest      158MB
quarkus/rest-heroes             latest      154MB</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_local_containers">Running local containers</h3>
<div class="paragraph">
<p>Now that we have all our Docker containers created, let&#8217;s execute them all to be sure that everything is working.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Under <code>super-heroes/infrastructure</code> you will find the <code>docker-compose-app-local.yaml</code> file.
It declares all the needed infrastructure (databases, Kafka) as well as our microservices.
Execute it with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker compose -f docker-compose-app-local.yaml up</code></pre>
</div>
</div>
<div class="paragraph">
<p>To know that all your containers are started, you can use the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker compose -f docker-compose-app-local.yaml ps</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should get something similar to the following list.
Make sure all your containers are in <em>running</em> status:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">event-statistics    "./application -Dqua…"   running
kafka               "sh -c 'export CLUST…"   running
rest-fights         "./application -Dqua…"   running
rest-heroes         "./application -Dqua…"   running
rest-villains       "./application -Dqua…"   running
super-database      "docker-entrypoint.s…"   running (healthy)
ui-super-heroes     "/bin/sh -c 'npm sta…"   running</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once all the containers are started, you can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Go to <a href="http://localhost:8080" class="bare">http://localhost:8080</a> to check the main UI</p>
</li>
<li>
<p>Go to <a href="http://localhost:8085" class="bare">http://localhost:8085</a> to check the statistics UI</p>
</li>
<li>
<p>curl <a href="http://localhost:8084/api/villains" class="bare">http://localhost:8084/api/villains</a> | jq</p>
</li>
<li>
<p>curl <a href="http://localhost:8083/api/heroes" class="bare">http://localhost:8083/api/heroes</a> | jq</p>
</li>
<li>
<p>curl <a href="http://localhost:8082/api/fights/randomfighters" class="bare">http://localhost:8082/api/fights/randomfighters</a> | jq</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then, make sure you shut down the entire application with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker compose -f docker-compose-app-local.yaml down</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pushing_containers_to_azure_container_registry">Pushing containers to Azure Container Registry</h3>
<div class="paragraph">
<p>Now that we have all our Docker containers running locally, let&#8217;s push them to Azure Container Registry.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Make sure you&#8217;ve set all the environment variables defined in the previous chapter and that you&#8217;ve also created the resource group and the Azure Container Registry.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Before you can push an image to your registry, you must tag it with the fully qualified name of your registry login server (the <code>REGISTRY_URL</code> variable).
Tag the image using the <code>docker tag</code> commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker tag quarkus/ui-super-heroes:latest   $UI_IMAGE
docker tag quarkus/event-statistics:latest  $STATISTICS_IMAGE
docker tag quarkus/rest-fights:latest       $FIGHTS_IMAGE
docker tag quarkus/rest-villains:latest     $VILLAINS_IMAGE
docker tag quarkus/rest-heroes:latest       $HEROES_IMAGE</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>To be able to push these Docker images to Azure Registry, we first need to log in to the registry:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az acr login \
  --name "$REGISTRY"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should see the prompt <em>Login Succeeded</em>.</p>
</div>
<div class="paragraph">
<p>Then, push all the images with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker push $UI_IMAGE
docker push $STATISTICS_IMAGE
docker push $FIGHTS_IMAGE
docker push $VILLAINS_IMAGE
docker push $HEROES_IMAGE</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check that the images have been pushed to Azure Container Registry by executing the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az acr repository list \
  --name "$REGISTRY" \
  --output table</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also get some information on a particular repository or image if needed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az acr repository show \
  --name "$REGISTRY" \
  --repository "$HEROES_APP"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can visualize the content of the registry on the <a href="https://portal.azure.com">Azure Portal</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/azure-portal-4.png" alt="azure portal 4">
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_remote_containers">Running remote containers</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>If you haven&#8217;t skipped the previous optional sections and built the containers your self, you should edit the <code>docker-compose-app-remote.yaml</code> file under <code>super-heroes/infrastructure</code> and change the name <code>superheroesregistry</code> with the value of the <code>$REGISTRY</code> variable.</p>
</div>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Now that we have all our Docker containers pushed to Azure Container Registry, let&#8217;s execute them with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker compose -f docker-compose-app-remote.yaml up</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>s
Once all the containers are started, you can:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Go to <a href="http://localhost:8080" class="bare">http://localhost:8080</a> to check the main UI</p>
</li>
<li>
<p>Go to <a href="http://localhost:8085" class="bare">http://localhost:8085</a> to check the statistics UI</p>
</li>
<li>
<p>curl <a href="http://localhost:8084/api/villains" class="bare">http://localhost:8084/api/villains</a> | jq</p>
</li>
<li>
<p>curl <a href="http://localhost:8083/api/heroes" class="bare">http://localhost:8083/api/heroes</a> | jq</p>
</li>
<li>
<p>curl <a href="http://localhost:8082/api/fights/randomfighters" class="bare">http://localhost:8082/api/fights/randomfighters</a> | jq</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>On <a href="http://localhost:8080" class="bare">http://localhost:8080</a> you should see the user interface, and you should be able to fight super heroes against super villains:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/angular-ui-ai.png" alt="angular ui ai">
</div>
</div>
<div class="paragraph">
<p>On <a href="http://localhost:8085" class="bare">http://localhost:8085</a> you should see the statistics of the fights.
When super heroes and super heroes are fights, the statistics shows which one has won the most fights, and the percentage of fights won by the two groups.
The UI is automatically updated at each fight:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/angular-ui-stats.png" alt="angular ui stats">
</div>
</div>
<div class="paragraph">
<p>You should see the user interface and everything should work.
Remember to shutdown the entire application with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">docker compose -f docker-compose-app-remote.yaml down</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ok, enough running these containers locally!
In the next chapter we will take these remote containers, configure them, and make them work remotely on Azure Container Apps.</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="azure-aca-running-app">Running the Application on Azure Container Apps</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>Now that we have containerized our application, push it to Azure Container Registry and execute it locally, time to execute it on Azure Container Apps.
In this chapter we will create the needed infrastructure in Azure Container Apps (database, Kafka, etc.) and then deploy the containers so we can execute our application.</p>
</div>
<div class="sect2">
<h3 id="_deploying_the_infrastructure">Deploying the Infrastructure</h3>
<div class="paragraph">
<p>Before deploying our microservices to Azure Container Apps, we need to create the infrastructure.</p>
</div>
<div class="sect3">
<h4 id="_create_a_container_apps_environment">Create a Container Apps environment</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>First, let&#8217;s create the container apps environment.
A container apps environment acts as a boundary for our containers.
Containers deployed on the same environment use the same virtual network and the same Log Analytics workspace.
Create the container apps environment with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az containerapp env create \
  --resource-group "$RESOURCE_GROUP" \
  --location "$LOCATION" \
  --tags system="$TAG" \
  --name "$CONTAINERAPPS_ENVIRONMENT" \
  --logs-workspace-id "$LOG_ANALYTICS_WORKSPACE_CLIENT_ID" \
  --logs-workspace-key "$LOG_ANALYTICS_WORKSPACE_CLIENT_SECRET"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_the_managed_postgres_databases">Create the managed Postgres Databases</h4>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>We need to create three PostgreSQL databases so the Heroes, Villains and Fights microservice can store data.
Because we also want to access these database from external SQL client, we make them available to the outside world thanks to the <code>-public all</code> parameter.
Create the databases with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server create \
  --resource-group "$RESOURCE_GROUP" \
  --location "$LOCATION" \
  --tags system="$TAG" application="$HEROES_APP" \
  --name "$HEROES_DB" \
  --admin-user "$POSTGRES_DB_ADMIN" \
  --admin-password "$POSTGRES_DB_PWD" \
  --public all \
  --tier "$POSTGRES_TIER" \
  --sku-name "$POSTGRES_SKU" \
  --storage-size 256 \
  --version "$POSTGRES_DB_VERSION"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server create \
  --resource-group "$RESOURCE_GROUP" \
  --location "$LOCATION" \
  --tags system="$TAG" application="$VILLAINS_APP" \
  --name "$VILLAINS_DB" \
  --admin-user "$POSTGRES_DB_ADMIN" \
  --admin-password "$POSTGRES_DB_PWD" \
  --public all \
  --tier "$POSTGRES_TIER" \
  --sku-name "$POSTGRES_SKU" \
  --storage-size 256 \
  --version "$POSTGRES_DB_VERSION"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server create \
  --resource-group "$RESOURCE_GROUP" \
  --location "$LOCATION" \
  --tags system="$TAG" application="$FIGHTS_APP" \
  --name "$FIGHTS_DB" \
  --admin-user "$POSTGRES_DB_ADMIN" \
  --admin-password "$POSTGRES_DB_PWD" \
  --public all \
  --tier "$POSTGRES_TIER" \
  --sku-name "$POSTGRES_SKU" \
  --storage-size 256 \
  --version "$POSTGRES_DB_VERSION"</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Then, we create the database schemas, one for each database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server db create \
    --resource-group "$RESOURCE_GROUP" \
    --server-name "$HEROES_DB" \
    --database-name "$HEROES_DB_SCHEMA"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server db create \
    --resource-group "$RESOURCE_GROUP" \
    --server-name "$VILLAINS_DB" \
    --database-name "$VILLAINS_DB_SCHEMA"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server db create \
    --resource-group "$RESOURCE_GROUP" \
    --server-name "$FIGHTS_DB" \
    --database-name "$FIGHTS_DB_SCHEMA"</code></pre>
</div>
</div>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Now that we have all our databases setup, time to create the tables and add some data to them.
Each microservice comes with a set of database initialization files as well as some insert statements.
Thanks to Azure CLI we can execute these SQL scripts.
Create the tables using the following commands (make sure you are under <code>quarkus-workshop-super-heroes/super-heroes</code> to execute them):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server execute \
    --name "$HEROES_DB" \
    --admin-user "$POSTGRES_DB_ADMIN" \
    --admin-password "$POSTGRES_DB_PWD" \
    --database-name "$HEROES_DB_SCHEMA" \
    --file-path "infrastructure/db-init/initialize-tables-heroes.sql"</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you get the error <code>No module named 'psycopg2._psycopg'</code> that means that some of your Azure CLI dependencies are not correctly installed.
Check <a href="https://github.com/Azure/azure-cli/issues/21998" class="bare">https://github.com/Azure/azure-cli/issues/21998</a> for help.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server execute \
    --name "$VILLAINS_DB" \
    --admin-user "$POSTGRES_DB_ADMIN" \
    --admin-password "$POSTGRES_DB_PWD" \
    --database-name "$VILLAINS_DB_SCHEMA" \
    --file-path "infrastructure/db-init/initialize-tables-villains.sql"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server execute \
    --name "$FIGHTS_DB" \
    --admin-user "$POSTGRES_DB_ADMIN" \
    --admin-password "$POSTGRES_DB_PWD" \
    --database-name "$FIGHTS_DB_SCHEMA" \
    --file-path "infrastructure/db-init/initialize-tables-fights.sql"</code></pre>
</div>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Now, let&#8217;s add some super heroes and super villains to these databases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server execute \
    --name "$HEROES_DB" \
    --admin-user "$POSTGRES_DB_ADMIN" \
    --admin-password "$POSTGRES_DB_PWD" \
    --database-name "$HEROES_DB_SCHEMA" \
    --file-path "rest-heroes/src/main/resources/import.sql"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server execute \
    --name "$VILLAINS_DB" \
    --admin-user "$POSTGRES_DB_ADMIN" \
    --admin-password "$POSTGRES_DB_PWD" \
    --database-name "$VILLAINS_DB_SCHEMA" \
    --file-path "rest-villains/src/main/resources/import.sql"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server execute \
    --name "$FIGHTS_DB" \
    --admin-user "$POSTGRES_DB_ADMIN" \
    --admin-password "$POSTGRES_DB_PWD" \
    --database-name "$FIGHTS_DB_SCHEMA" \
    --file-path "rest-fights/src/main/resources/import.sql"</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can check the content of the tables with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server execute \
    --name "$HEROES_DB" \
    --admin-user "$POSTGRES_DB_ADMIN" \
    --admin-password "$POSTGRES_DB_PWD" \
    --database-name "$HEROES_DB_SCHEMA" \
    --querytext "select * from hero"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server execute \
    --name "$VILLAINS_DB" \
    --admin-user "$POSTGRES_DB_ADMIN" \
    --admin-password "$POSTGRES_DB_PWD" \
    --database-name "$VILLAINS_DB_SCHEMA" \
    --querytext "select * from villain"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az postgres flexible-server execute \
    --name "$FIGHTS_DB" \
    --admin-user "$POSTGRES_DB_ADMIN" \
    --admin-password "$POSTGRES_DB_PWD" \
    --database-name "$FIGHTS_DB_SCHEMA" \
    --querytext "select * from fight"</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_the_managed_kafka">Create the Managed Kafka</h4>
<div class="paragraph">
<p>The Fight microservice communicates with the Statistics microservice through Kafka.
We need to create an Azure event hub for that.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az eventhubs namespace create \
  --resource-group "$RESOURCE_GROUP" \
  --location "$LOCATION" \
  --tags system="$TAG" application="$FIGHTS_APP" \
  --name "$KAFKA_NAMESPACE"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, create the Kafka topic where the messages will be sent to and consumed from:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az eventhubs eventhub create \
  --resource-group "$RESOURCE_GROUP" \
  --name "$KAFKA_TOPIC" \
  --namespace-name "$KAFKA_NAMESPACE"</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure Kafka in the Fight and Statistics microservices, get the connection string with the following commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">KAFKA_CONNECTION_STRING=$(az eventhubs namespace authorization-rule keys list \
  --resource-group "$RESOURCE_GROUP" \
  --namespace-name "$KAFKA_NAMESPACE" \
  --name RootManageSharedAccessKey \
  --output json | jq -r .primaryConnectionString)

JAAS_CONFIG='org.apache.kafka.common.security.plain.PlainLoginModule required username="$ConnectionString" password="'
KAFKA_JAAS_CONFIG="${JAAS_CONFIG}${KAFKA_CONNECTION_STRING}\";"

echo $KAFKA_CONNECTION_STRING
echo $KAFKA_JAAS_CONFIG</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you log into the <a href="https://portal.azure.com">Azure Portal</a> you should see the following created resources.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/azure-portal-3.png" alt="azure portal 3">
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deploying_the_applications">Deploying the Applications</h3>
<div class="paragraph">
<p>Now that the Azure Container Apps environment is all set, we need to deploy our microservices to Azure Container Apps.
So let&#8217;s create an instance of Container Apps for each of our microservices and User Interface.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>If you haven&#8217;t built the containers and push them to your own Azure Container Registry, you need to change some environment variables.
That means, that instead of having <code>REGISTRY="superheroesregistry"$UNIQUE_IDENTIFIER</code>, you need to change it to <code>REGISTRY="superheroesregistry</code> (so it uses the common registry).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">REGISTRY="registrysuperheroesagoncal"

REGISTRY_URL=$(az acr show \
  --resource-group "$RESOURCE_GROUP" \
  --name "$REGISTRY" \
  --query "loginServer" \
  --output tsv)

HEROES_IMAGE="${REGISTRY_URL}/${HEROES_APP}:${IMAGES_TAG}"
VILLAINS_IMAGE="${REGISTRY_URL}/${VILLAINS_APP}:${IMAGES_TAG}"
FIGHTS_IMAGE="${REGISTRY_URL}/${FIGHTS_APP}:${IMAGES_TAG}"
STATISTICS_IMAGE="${REGISTRY_URL}/${STATISTICS_APP}:${IMAGES_TAG}"
UI_IMAGE="${REGISTRY_URL}/${UI_APP}:${IMAGES_TAG}"</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_heroes_microservice">Heroes Microservice</h4>
<div class="paragraph">
<p>First, the Heroes microservice.
The Heroes microservice needs to access the managed Postgres database.
Therefore, we need to set the right properties using our environment variables.
Notice that the Heroes microservice has a <code>--min-replicas</code> set to 0.
That means it can scale down to zero if not used (more on that later).</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create the Heroes container app with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az containerapp create \
  --resource-group "$RESOURCE_GROUP" \
  --tags system="$TAG" application="$HEROES_APP" \
  --image "$HEROES_IMAGE" \
  --name "$HEROES_APP" \
  --environment "$CONTAINERAPPS_ENVIRONMENT" \
  --ingress external \
  --target-port 8083 \
  --min-replicas 0 \
  --env-vars QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=validate \
             QUARKUS_HIBERNATE_ORM_SQL_LOAD_SCRIPT=no-file \
             QUARKUS_DATASOURCE_USERNAME="$POSTGRES_DB_ADMIN" \
             QUARKUS_DATASOURCE_PASSWORD="$POSTGRES_DB_PWD" \
             QUARKUS_DATASOURCE_REACTIVE_URL="$HEROES_DB_CONNECT_STRING"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following command sets the URL of the deployed application to the <code>HEROES_URL</code> variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">HEROES_URL="https://$(az containerapp ingress show \
    --resource-group "$RESOURCE_GROUP" \
    --name "$HEROES_APP" \
    --output json | jq -r .fqdn)"

echo $HEROES_URL</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now invoke the Hero microservice APIs with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">curl "$HEROES_URL/api/heroes/hello"
curl "$HEROES_URL/api/heroes" | jq</code></pre>
</div>
</div>
<div class="paragraph">
<p>To access the logs of the Heroes microservice, you can write the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az monitor log-analytics query \
  --workspace $LOG_ANALYTICS_WORKSPACE_CLIENT_ID \
  --analytics-query "ContainerAppConsoleLogs_CL | where ContainerAppName_s == '$HEROES_APP' | project ContainerAppName_s, Log_s, TimeGenerated " \
  --output table</code></pre>
</div>
</div>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You might have to wait to be able to get the logs.
Log analytics can take some time to get initialized.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_villains_microservice">Villains Microservice</h4>
<div class="paragraph">
<p>The Villain microservice also needs to access the managed Postgres database, so we need to set the right variables.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Notice the minimum of replicas is also set to 0:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az containerapp create \
  --resource-group "$RESOURCE_GROUP" \
  --tags system="$TAG" application="$VILLAINS_APP" \
  --image "$VILLAINS_IMAGE" \
  --name "$VILLAINS_APP" \
  --environment "$CONTAINERAPPS_ENVIRONMENT" \
  --ingress external \
  --target-port 8084 \
  --min-replicas 0 \
  --env-vars QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=validate \
             QUARKUS_HIBERNATE_ORM_SQL_LOAD_SCRIPT=no-file \
             QUARKUS_DATASOURCE_USERNAME="$POSTGRES_DB_ADMIN" \
             QUARKUS_DATASOURCE_PASSWORD="$POSTGRES_DB_PWD" \
             QUARKUS_DATASOURCE_JDBC_URL="$VILLAINS_DB_CONNECT_STRING"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following command sets the URL of the deployed application to the <code>VILLAINS_URL</code> variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">VILLAINS_URL="https://$(az containerapp ingress show \
    --resource-group "$RESOURCE_GROUP" \
    --name "$VILLAINS_APP" \
    --output json | jq -r .fqdn)"

echo $VILLAINS_URL</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now invoke the Hero microservice APIs with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">curl "$VILLAINS_URL/api/villains/hello"
curl "$VILLAINS_URL/api/villains" | jq</code></pre>
</div>
</div>
<div class="paragraph">
<p>To access the logs of the Villain microservice, you can write the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az monitor log-analytics query \
  --workspace $LOG_ANALYTICS_WORKSPACE_CLIENT_ID \
  --analytics-query "ContainerAppConsoleLogs_CL | where ContainerAppName_s == '$VILLAINS_APP' | project ContainerAppName_s, Log_s, TimeGenerated " \
  --output table</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_statistics_microservice">Statistics Microservice</h4>
<div class="paragraph">
<p>The Statistics microservice listens to a Kafka topics and consumes all the fights.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create the Statistics container application with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az containerapp create \
  --resource-group "$RESOURCE_GROUP" \
  --tags system="$TAG" application="$STATISTICS_APP" \
  --image "$STATISTICS_IMAGE" \
  --name "$STATISTICS_APP" \
  --environment "$CONTAINERAPPS_ENVIRONMENT" \
  --ingress external \
  --target-port 8085 \
  --min-replicas 0 \
  --env-vars KAFKA_BOOTSTRAP_SERVERS="$KAFKA_BOOTSTRAP_SERVERS" \
             KAFKA_SECURITY_PROTOCOL=SASL_SSL \
             KAFKA_SASL_MECHANISM=PLAIN \
             KAFKA_SASL_JAAS_CONFIG="$KAFKA_JAAS_CONFIG"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following command sets the URL of the deployed application to the <code>STATISTICS_URL</code> variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">STATISTICS_URL="https://$(az containerapp ingress show \
    --resource-group "$RESOURCE_GROUP" \
    --name "$STATISTICS_APP" \
    --output json | jq -r .fqdn)"

echo $STATISTICS_URL</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can now display the Statistics UI with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">open "$STATISTICS_URL"</code></pre>
</div>
</div>
<div class="paragraph">
<p>To access the logs of the Statistics microservice, you can write the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az monitor log-analytics query \
  --workspace $LOG_ANALYTICS_WORKSPACE_CLIENT_ID \
  --analytics-query "ContainerAppConsoleLogs_CL | where ContainerAppName_s == '$STATISTICS_APP' | project ContainerAppName_s, Log_s, TimeGenerated " \
  --output table</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_fights_microservice">Fights Microservice</h4>
<div class="paragraph">
<p>The Fight microservice invokes the Heroes and Villains microservices, sends fight messages to a Kafka topics and stores the fights into a MongoDB database.
We need to configure Kafka (same connection string as the one used by the Statistics microservice) as well as the Postgres database.
As for the microservice invocations, you need to set the URLs of both Heroes and Villains microservices.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>Create the Fights container application with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az containerapp create \
  --resource-group "$RESOURCE_GROUP" \
  --tags system="$TAG" application="$FIGHTS_APP" \
  --image "$FIGHTS_IMAGE" \
  --name "$FIGHTS_APP" \
  --environment "$CONTAINERAPPS_ENVIRONMENT" \
  --ingress external \
  --target-port 8082 \
  --min-replicas 0 \
  --env-vars QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=validate \
             QUARKUS_HIBERNATE_ORM_SQL_LOAD_SCRIPT=no-file \
             QUARKUS_DATASOURCE_USERNAME="$POSTGRES_DB_ADMIN" \
             QUARKUS_DATASOURCE_PASSWORD="$POSTGRES_DB_PWD" \
             QUARKUS_DATASOURCE_JDBC_URL="$FIGHTS_DB_CONNECT_STRING" \
             KAFKA_BOOTSTRAP_SERVERS="$KAFKA_BOOTSTRAP_SERVERS" \
             KAFKA_SECURITY_PROTOCOL=SASL_SSL \
             KAFKA_SASL_MECHANISM=PLAIN \
             KAFKA_SASL_JAAS_CONFIG="$KAFKA_JAAS_CONFIG" \
             IO_QUARKUS_WORKSHOP_SUPERHEROES_FIGHT_CLIENT_HEROPROXY_MP_REST_URL="$HEROES_URL" \
             IO_QUARKUS_WORKSHOP_SUPERHEROES_FIGHT_CLIENT_VILLAINPROXY_MP_REST_URL="$VILLAINS_URL"</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following command sets the URL of the deployed application to the <code>FIGHTS_URL</code> variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">FIGHTS_URL="https://$(az containerapp ingress show \
    --resource-group "$RESOURCE_GROUP" \
    --name "$FIGHTS_APP" \
    --output json | jq -r .fqdn)"

echo $FIGHTS_URL</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the following curl commands to access the Fight microservice.
Remember that we&#8217;ve set the minimum replicas to 0.
That means that pinging the Hero and Villain microservices might fallback (you will get a <em>That means that pinging the Hero and Villain microservices might fallback (you will get a That means that pinging the Hero and Villain microservices might fallback (you will get a _Could not invoke the Villains microservice</em> message).
Execute several times the same curl commands so Azure Containers Apps has time to instantiate one replica and process the requests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">curl "$FIGHTS_URL/api/fights/hello"
curl "$FIGHTS_URL/api/fights" | jq
curl "$FIGHTS_URL/api/fights/randomfighters" | jq</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To access the logs of the Fight microservice, you can write the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az monitor log-analytics query \
  --workspace $LOG_ANALYTICS_WORKSPACE_CLIENT_ID \
  --analytics-query "ContainerAppConsoleLogs_CL | where ContainerAppName_s == '$FIGHTS_APP' | project ContainerAppName_s, Log_s, TimeGenerated " \
  --output table</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_super_hero_ui">Super Hero UI</h4>
<div class="paragraph">
<p>Like for the previous microservices, we will be deploying the UI as Docker image as we did for the previous microservices.
But we could have also deployed the Super Hero UI using Azure Static Webapps which is suited for Angular applications.
If you are interested in this approach, you can check <a href="https://azure.microsoft.com/services/app-service/static/">Azure Static Webapps</a>.</p>
</div>
<div class="exampleblock cta">
<div class="content">
<div class="paragraph">
<p>For now, let&#8217;s continue with Azure Container Apps and deploy the UI as a Docker image with the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az containerapp create \
  --resource-group "$RESOURCE_GROUP" \
  --tags system="$TAG" application="$UI_APP" \
  --image "$UI_IMAGE" \
  --name "$UI_APP" \
  --environment "$CONTAINERAPPS_ENVIRONMENT" \
  --ingress external \
  --target-port 8080 \
  --env-vars API_BASE_URL="$FIGHTS_URL"</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">UI_URL="https://$(az containerapp ingress show \
    --resource-group "$RESOURCE_GROUP" \
    --name "$UI_APP" \
    --output json | jq -r .fqdn)"

echo $UI_URL</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">open "$UI_URL"</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To access the UI logs, you can write the following query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az monitor log-analytics query \
  --workspace $LOG_ANALYTICS_WORKSPACE_CLIENT_ID \
  --analytics-query "ContainerAppConsoleLogs_CL | where ContainerAppName_s == '$UI_APP' | project ContainerAppName_s, Log_s, TimeGenerated " \
  --output table</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_running_the_application">Running the Application</h3>
<div class="paragraph">
<p>Now that the entire infrastructure is created and the microservices deployed, you can use all the following commands to either, directly invoke the APIs, or use the user interfaces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">curl "$HEROES_URL/api/heroes" | jq
curl "$VILLAINS_URL/api/villains" | jq
curl "$FIGHTS_URL/api/fights/randomfighters" | jq
open "$STATISTICS_URL"
open "$UI_URL"</code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="azure-conclusion">Clean Up Azure Resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Do NOT forget to remove the Azure resources once you are done running the workshop.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">az group delete \
  --name "$RESOURCE_GROUP"</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<hr>
<div class="paragraph">
<p>This is the end of the Super Hero workshop.
We hope you liked it, learnt a few things, and more importantly, will be able to take this knowledge back to your projects.</p>
</div>
<div class="paragraph">
<p>This workshop started making sure your development environment was ready to develop the entire application.
Then, there was some brief terminology to help you in understanding some concepts around Quarkus.
If you find it was too short and need more details on Quarkus, Microservices, MicroProfile, Cloud Native, or GraalVM, check the Quarkus website for more references.<sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</div>
<div class="paragraph">
<p>Then, we focused on developing several isolated microservices.
Some written in pure JAX-RS (such as the Villain) others with Reactive JAX-RS and Reactive Hibernate (such as the Hero).
These microservices return a data in JSON, validate data thanks to Bean Validation, store and retrieve data from a relational database with the help of JPA, Panache and JTA.</p>
</div>
<div class="paragraph">
<p>You then installed an already coded Angular application on another instance of Quarkus.
At this stage, the Angular application couldn&#8217;t access the microservices because of CORS issues that we quickly fixed.</p>
</div>
<div class="paragraph">
<p>Then, we made the microservices communicate with each other in HTTP thanks to REST Client.
But HTTP-related technologies usually use synchronous communication and therefore need to deal with invocation failure.
With Fault Tolerance, it was just a matter of using a few annotations and we can get some fallback when the communication fails.</p>
</div>
<div class="paragraph">
<p>That&#8217;s also why we introduced Reactive Messaging with Kafka: so we don&#8217;t have a temporal coupling between the microservices.</p>
</div>
<div class="paragraph">
<p>Remember that you can find all the code for this fascicle at <a href="https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes" class="bare">https://github.com/quarkusio/quarkus-workshops/tree/refs/heads/main/quarkus-workshop-super-heroes</a>.
If some parts were not clear enough, or if you found something missing, a bug, or you just want to leave a note or suggestion, please use the GitHub issue tracker at <a href="https://quarkus.io/" class="bare">https://quarkus.io/</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="azure-conclusion-references">References</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://quarkus.io/quarkus-workshops/super-heroes" class="bare">https://quarkus.io/quarkus-workshops/super-heroes</a></p>
</li>
<li>
<p><a href="https://github.com/cescoffier/quarkus-todo-app" class="bare">https://github.com/cescoffier/quarkus-todo-app</a></p>
</li>
<li>
<p><a href="https://github.com/agoncal/baking-microservice-pie" class="bare">https://github.com/agoncal/baking-microservice-pie</a></p>
</li>
<li>
<p><a href="https://forge.jboss.org/document/hands-on-lab" class="bare">https://forge.jboss.org/document/hands-on-lab</a></p>
</li>
<li>
<p><a href="https://bit.ly/forge-hol" class="bare">https://bit.ly/forge-hol</a></p>
</li>
<li>
<p><a href="https://quarkus.io" class="bare">https://quarkus.io</a></p>
</li>
<li>
<p><a href="https://code.quarkus.io" class="bare">https://code.quarkus.io</a></p>
</li>
<li>
<p><a href="https://quarkus.io/guides/all-config" class="bare">https://quarkus.io/guides/all-config</a></p>
</li>
<li>
<p><a href="https://azure.microsoft.com/services/container-apps">Azure Container Apps Overview</a></p>
</li>
<li>
<p><a href="https://docs.microsoft.com/azure/container-apps">Azure Container Apps Documentation</a></p>
</li>
<li>
<p><a href="https://github.com/ozangunalp/managed-kafka-quarkus/tree/main/azure-event-hub">Managed Kafka Quarkus</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Docker commands <a href="https://docs.docker.com/engine/reference/commandline/cli" class="bare">https://docs.docker.com/engine/reference/commandline/cli</a>
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Git <a href="https://git-scm.com" class="bare">https://git-scm.com</a>
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. Also called Ahead-of-Time Compilation <a href="https://www.graalvm.org/docs/reference-manual/native-image" class="bare">https://www.graalvm.org/docs/reference-manual/native-image</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. Quarkus <a href="https://quarkus.io" class="bare">https://quarkus.io</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2023-10-03 09:28:13 UTC
</div>
</div>
</body>
</html>